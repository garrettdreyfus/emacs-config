import shapefile
import rockhound as rh
import matplotlib.pyplot as plt
import cmocean
import numpy as np
import itertools, pickle
from tqdm import tqdm
from shapely.geometry import Polygon, Point
import time
import xarray, pyproj


with open("data/shelfpolygons.pickle","rb") as f:
    polygons = pickle.load(f)

sal = xarray.open_dataset("data/woa18_decav81B0_s00_04.nc",decode_times=False)
temp = xarray.open_dataset("data/woa18_decav81B0_t00_04.nc",decode_times=False)
sal = sal.where(sal.lat<-60,drop=True)
temp= temp.where(sal.lat<-60,drop=True)

plt.figure(figsize=(16, 14))
ax = plt.subplot(111)
sal['pycnocline']  = sal.s_an.copy()
sal.pycnocline[:] = np.nan

t_an = temp.t_an.values
s_an = sal.s_an.values
d = sal.depth.values
lons=sal.lon.values
lats=sal.lat.values

projection = pyproj.Proj("epsg:3031")
lons,lats = np.meshgrid(sal.lon,sal.lat)
x,y = projection.transform(lons,lats)
sal.coords["x"]= (("lat","lon"),x)
sal.coords["y"]= (("lat","lon"),y)

shelf = polygons["Pine_Island"]

s_an_val = sal.s_an.values
depthmask = np.full_like(sal.s_an[0,0,:,:].values,np.nan,dtype=bool)
for i in range(depthmask.shape[0]):
    for j in range(depthmask.shape[1]):
        if ~(np.isnan(sal.s_an.values[0,:,i,j])).all():
            depthmask[i,j] = (d[np.nanargmax(sal.s_an.values[0,:,i,j])]>1000)

plt.imshow(depthmask)
plt.show()
sal.s_an[0,0,:,:].values[mask]=0

centroid = list(shelf.centroid.coords)[0]
mask = np.full_like(sal.s_an[0,0,:,:].values,np.nan,dtype=bool)
dist = np.sqrt((sal.coords["x"]- centroid[0])**2 + (sal.coords["y"] - centroid[1])**2)
radius=100*10**3
mask[dist<100000] = True
mask[dist>100000] = False#np.nan


sal.s_an[0,0,:,:].plot.pcolormesh(
    ax=ax, cmap="jet", cbar_kwargs=dict(pad=0.01, aspect=30),\
    x="x",y="y")
plt.show()
